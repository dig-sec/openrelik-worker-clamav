---
# OpenRelik database initialization and migrations
- name: Note when migrations are disabled
  debug:
    msg: "Skipping migrations: openrelik_run_migrations is false."
  when: not (openrelik_run_migrations | default(true))

- name: Wait for PostgreSQL to be ready
  shell: |
    cd {{ openrelik_install_dir }}/openrelik
    for i in $(seq 1 30); do
      if docker compose exec -T openrelik-postgres sh -c 'pg_isready -U "$POSTGRES_USER"' > /dev/null 2>&1; then
        echo "PostgreSQL is ready"
        exit 0
      fi
      echo "Waiting for PostgreSQL..."
      sleep 2
    done
    echo "PostgreSQL failed to become ready"
    exit 1
  register: pg_ready
  changed_when: false
  when: openrelik_run_migrations | default(true)

- name: Check for Alembic configuration
  shell: |
    cd {{ openrelik_install_dir }}/openrelik
    docker compose exec -T openrelik-server sh -c 'test -f /app/openrelik/alembic.ini'
  register: alembic_config
  changed_when: false
  failed_when: false
  when: openrelik_run_migrations | default(true)

- name: Note when Alembic config is missing
  debug:
    msg: "Skipping migrations: Alembic config not found in openrelik-server container."
  when: (openrelik_run_migrations | default(true)) and alembic_config.rc != 0

- name: Run database migrations
  shell: |
    cd {{ openrelik_install_dir }}/openrelik
    docker compose exec -T openrelik-server alembic upgrade head
  args:
    chdir: "{{ openrelik_install_dir }}/openrelik"
  register: migrations
  changed_when: "'Running upgrade' in migrations.stdout"
  when: (openrelik_run_migrations | default(true)) and alembic_config.rc == 0

- name: Show migration output
  debug:
    var: migrations.stdout_lines
  when: migrations.stdout_lines is defined and (openrelik_run_migrations | default(true)) and alembic_config.rc == 0

- name: Check OpenRelik server health
  uri:
    url: http://localhost:8710/healthz
    method: GET
    status_code: 200
  register: health_check
  until: health_check.status == 200
  retries: 12
  delay: 5
  ignore_errors: yes

- name: Display health check result
  debug:
    msg: "OpenRelik server is {{ 'healthy' if health_check.status == 200 else 'not responding' }}"
