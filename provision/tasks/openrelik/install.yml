---
# OpenRelik installation tasks
- name: Download OpenRelik install script
  get_url:
    url: https://raw.githubusercontent.com/openrelik/openrelik-deploy/main/docker/install.sh
    dest: "{{ openrelik_install_dir }}/install.sh"
    mode: '0755'
    owner: "{{ openrelik_user }}"
    group: "{{ openrelik_user }}"

- name: Run OpenRelik install script
  shell: bash install.sh
  args:
    chdir: "{{ openrelik_install_dir }}"
    creates: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
  # Run as root to avoid docker socket permission issues during initial setup
  become_user: "root"

- name: Configure OpenRelik API endpoint for direct access
  lineinfile:
    path: "{{ openrelik_install_dir }}/openrelik/.env"
    regexp: '^OPENRELIK_SERVER_URL='
    line: "OPENRELIK_SERVER_URL=http://{{ ansible_default_ipv4.address }}:{{ openrelik_api_port_internal }}"
  notify: Restart OpenRelik services

- name: Bind OpenRelik API to lab network
  shell: |
    sed -i 's/127\.0\.0\.1:{{ openrelik_api_port_internal }}:{{ openrelik_api_port_internal }}/0.0.0.0:{{ openrelik_api_port_internal }}:{{ openrelik_api_port_internal }}/' "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
  notify: Restart OpenRelik services

- name: Bind OpenRelik UI to lab network
  shell: |
    sed -i 's/127\.0\.0\.1:{{ openrelik_ui_port_internal }}:{{ openrelik_ui_port_internal }}/0.0.0.0:{{ openrelik_ui_port_internal }}:{{ openrelik_ui_port_internal }}/' "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
  notify: Restart OpenRelik services

- name: Ensure OpenRelik config directory exists
  file:
    path: "{{ openrelik_install_dir }}/openrelik/config"
    state: directory
    owner: "{{ openrelik_user }}"
    group: "{{ openrelik_user }}"
    mode: '0755'

- name: Write settings.toml with OAuth (if configured)
  copy:
    dest: "{{ openrelik_install_dir }}/openrelik/config/settings.toml"
    owner: "{{ openrelik_user }}"
    group: "{{ openrelik_user }}"
    mode: '0644'
    content: |
      [oauth]
      client_id = "{{ openrelik_client_id | default('') }}"
      client_secret = "{{ openrelik_client_secret | default('') }}"

      [access]
      allowlist = {{ (openrelik_allowlist | default([])) | to_nice_json }}
  when: (openrelik_client_id | default('')) != '' and (openrelik_client_secret | default('')) != ''

- name: Note - Local auth will use default Docker credentials
  debug:
    msg:
      - "No OAuth credentials provided."
      - "OpenRelik will use local authentication."
      - "Default credentials: admin / admin (after first startup)"
  when: (openrelik_client_id | default('')) == '' or (openrelik_client_secret | default('')) == ''

- name: Check if settings.toml exists
  stat:
    path: "{{ openrelik_install_dir }}/openrelik/config/settings.toml"
  register: settings_file

- name: Create helper script to start OpenRelik
  copy:
    dest: /usr/local/bin/openrelik-start
    mode: '0755'
    content: |
      #!/bin/bash
      cd {{ openrelik_install_dir }}/openrelik
      docker compose up -d
      echo "OpenRelik started!"
      echo "UI: http://localhost:{{ openrelik_ui_port_internal }}/"
      echo "API: http://localhost:{{ openrelik_api_port_internal }}/api/v1/docs/"

- name: Create helper script to stop OpenRelik
  copy:
    dest: /usr/local/bin/openrelik-stop
    mode: '0755'
    content: |
      #!/bin/bash
      cd {{ openrelik_install_dir }}/openrelik
      docker compose down
      echo "OpenRelik stopped!"

- name: Create helper script to view logs
  copy:
    dest: /usr/local/bin/openrelik-logs
    mode: '0755'
    content: |
      #!/bin/bash
      cd {{ openrelik_install_dir }}/openrelik
      docker compose logs -f
