---
# Neko browser containers setup
- name: Create neko directory
  file:
    path: "{{ neko_install_dir }}"
    state: directory
    mode: '0755'

- name: Create neko config directory
  file:
    path: "{{ neko_install_dir }}/config"
    state: directory
    mode: '0755'

- name: Create docker-compose.yml for neko
  copy:
    content: |
      version: '3.8'
      
      services:
        neko-tor:
          image: ghcr.io/m1k1o/neko/tor-browser:latest
          container_name: neko-tor-browser
          restart: unless-stopped
          shm_size: 2gb
          ports:
            - "{{ neko_port }}:8080"
            - "{{ neko_broadcast_port }}:8081/udp"
            - "52000-52099:52000-52099/udp"
          environment:
            - NEKO_DESKTOP_SCREEN=1920x1080
            - NEKO_MEMBER_PROVIDER=multiuser
            - NEKO_MEMBER_MULTIUSER_USER_PASSWORD={{ neko_password }}
            - NEKO_MEMBER_MULTIUSER_ADMIN_PASSWORD={{ neko_admin_password }}
            - NEKO_SERVER_BIND=0.0.0.0:8080
            - NEKO_WEBRTC_BIND=0.0.0.0:8081
            - NEKO_WEBRTC_IP={{ neko_webrtc_ip if (neko_webrtc_ip | default('') | length) > 0 else ansible_default_ipv4.address }}
            - NEKO_WEBRTC_EPR=52000-52099
          cap_add:
            - SYS_ADMIN
          networks:
            - neko-network

        neko-chromium:
          image: ghcr.io/m1k1o/neko/chromium:latest
          container_name: neko-chromium-browser
          restart: unless-stopped
          shm_size: 2gb
          ports:
            - "{{ neko_chromium_port }}:8080"
            - "{{ neko_chromium_broadcast_port }}:8081/udp"
            - "52100-52199:52100-52199/udp"
          environment:
            - NEKO_DESKTOP_SCREEN=1920x1080
            - NEKO_MEMBER_PROVIDER=multiuser
            - NEKO_MEMBER_MULTIUSER_USER_PASSWORD={{ neko_password }}
            - NEKO_MEMBER_MULTIUSER_ADMIN_PASSWORD={{ neko_admin_password }}
            - NEKO_SERVER_BIND=0.0.0.0:8080
            - NEKO_WEBRTC_BIND=0.0.0.0:8081
            - NEKO_WEBRTC_IP={{ neko_webrtc_ip if (neko_webrtc_ip | default('') | length) > 0 else ansible_default_ipv4.address }}
            - NEKO_WEBRTC_EPR=52100-52199
          cap_add:
            - SYS_ADMIN
          networks:
            - neko-network

      networks:
        neko-network:
          driver: bridge
    dest: "{{ neko_install_dir }}/docker-compose.yml"
    mode: '0644'

- name: Start neko containers
  shell: |
    cd {{ neko_install_dir }}
    docker-compose up -d
  register: neko_start
  changed_when: "'Creating' in neko_start.stdout or 'Starting' in neko_start.stdout"

- name: Wait for Neko Tor to be ready
  wait_for:
    port: "{{ neko_port }}"
    delay: 5
    timeout: 60

- name: Wait for Neko Chromium to be ready
  wait_for:
    port: "{{ neko_chromium_port }}"
    delay: 5
    timeout: 60

- name: Display neko URLs
  debug:
    msg:
      - "Neko Tor Browser: http://10.20.0.40:{{ neko_port }}"
      - "Neko Chromium: http://10.20.0.40:{{ neko_chromium_port }}"
      - "WebRTC broadcast ports configured for lab network access"
