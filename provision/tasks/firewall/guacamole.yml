---
# Guacamole Docker setup tasks
- name: Check if Guacamole has been installed
  stat:
    path: /opt/guacamole/.installed
  register: guac_installed
  when: enable_guacamole

- name: Install Docker for Guacamole
  apt:
    name:
      - docker.io
      - docker-compose
    state: present
  when: enable_guacamole

- name: Set iptables to legacy mode for Docker compatibility
  alternatives:
    name: "{{ item }}"
    path: "/usr/sbin/{{ item }}-legacy"
  loop:
    - iptables
    - ip6tables
  when: enable_guacamole

- name: Restart Docker after iptables change
  systemd:
    name: docker
    state: restarted
  when: enable_guacamole

- name: Create Guacamole config directory
  file:
    path: /opt/guacamole
    state: directory
    mode: '0755'
  when: enable_guacamole

- name: Ensure Docker service is running (Guacamole)
  systemd:
    name: docker
    state: started
  when: enable_guacamole

- name: Create Guacamole init script directory
  file:
    path: /opt/guacamole/initdb.d
    state: directory
    mode: '0755'
  when: enable_guacamole

- name: Copy Guacamole schema initialization script
  shell: |
    docker run --rm guacamole/guacamole cat /opt/guacamole/postgresql/schema/*.sql > /opt/guacamole/initdb.d/001-initdb.sql
  args:
    creates: /opt/guacamole/initdb.d/001-initdb.sql
  when: enable_guacamole
  register: guac_init_result
  failed_when: false

- name: Copy Guacamole connection pre-configuration script
  copy:
    src: guacamole-connections.sql
    dest: /opt/guacamole/initdb.d/002-connections.sql
    mode: '0644'
  when: enable_guacamole

- name: Deploy Guacamole docker-compose file
  copy:
    dest: /opt/guacamole/docker-compose.yml
    mode: '0644'
    content: |
      version: '3.8'
      
      services:
        guacd:
          container_name: guacamole_backend
          image: guacamole/guacd
          restart: unless-stopped
          volumes:
            - guac_drive:/drive
            - guac_record:/record
        
        postgres:
          container_name: guacamole_database
          environment:
            PGDATA: /var/lib/postgresql/data/guacamole
            POSTGRES_DB: guacamole_db
            POSTGRES_PASSWORD: 'guacamole'
            POSTGRES_USER: guacamole_user
          image: postgres:15
          restart: unless-stopped
          volumes:
            - /opt/guacamole/initdb.d:/docker-entrypoint-initdb.d:ro
            - guac_data:/var/lib/postgresql/data:rw
        
        guacamole:
          container_name: guacamole_frontend
          depends_on:
            - guacd
            - postgres
          environment:
            GUACD_HOSTNAME: guacd
            POSTGRES_DATABASE: guacamole_db
            POSTGRES_HOSTNAME: postgres
            POSTGRES_PASSWORD: 'guacamole'
            POSTGRES_USER: guacamole_user
          image: guacamole/guacamole
          links:
            - guacd
          ports:
            - 8080:8080
          restart: unless-stopped
      
      volumes:
        guac_drive:
        guac_record:
        guac_data:
  when: enable_guacamole

- name: Remove Guacamole Postgres volume on first install
  shell: |
    docker volume rm guacamole_guac_data || true
  when: enable_guacamole and not guac_installed.stat.exists
  changed_when: true

- name: Ensure Guacamole stack is running
  shell: |
    cd /opt/guacamole
    docker-compose up -d
  when: enable_guacamole
  register: guac_start
  changed_when: "'Creating' in guac_start.stdout or 'Starting' in guac_start.stdout"

- name: Wait for Guacamole to be ready
  wait_for:
    port: 8080
    delay: 10
    timeout: 60
  when: enable_guacamole

- name: Install RDP and desktop environment
  apt:
    name:
      - xrdp
      - xfce4
      - xfce4-goodies
      - dbus-x11
    state: present
  when: enable_guacamole

- name: Mark Guacamole installed
  file:
    path: /opt/guacamole/.installed
    state: touch
    mode: '0644'
  when: enable_guacamole
