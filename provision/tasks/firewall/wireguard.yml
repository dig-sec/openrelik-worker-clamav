---
# WireGuard VPN configuration tasks
- name: Enable IPv6 for WireGuard tunnel
  sysctl:
    name: "{{ item }}"
    value: '0'
    sysctl_set: yes
    state: present
  loop:
    - net.ipv6.conf.all.disable_ipv6
    - net.ipv6.conf.default.disable_ipv6
  when: wg0_conf | length > 0

- name: Write WireGuard configuration if provided
  copy:
    dest: /etc/wireguard/wg0.conf
    content: "{{ wg0_conf }}"
    mode: '0600'
  when: wg0_conf | length > 0

- name: Ensure wg-quick service is enabled
  systemd:
    name: wg-quick@wg0
    enabled: yes
  when: wg0_conf | length > 0

- name: Bring up wg0 interface
  command: wg-quick up wg0
  register: wg_up_result
  changed_when: wg_up_result.rc == 0
  failed_when: false
  when: wg0_conf | length > 0

- name: Wait for WireGuard interface to be ready
  wait_for:
    timeout: 5
  when: wg0_conf | length > 0

- name: Verify Mullvad tunnel is active
  shell: |
    set -e
    # Check if wg0 interface exists
    ip addr show wg0 | grep -q inet || exit 1
    
    # Check if we have a WireGuard peer configured
    wg show wg0 | grep -q peer || exit 1
    
    # Test connectivity through tunnel
    timeout 10 curl -s --interface wg0 https://am.i.mullvad.net/json | jq -e '.mullvad_exit_ip' > /dev/null || exit 1
    
    echo "Mullvad tunnel verified and operational"
  register: mullvad_verify
  changed_when: false
  when: wg0_conf | length > 0

- name: Display Mullvad status
  debug:
    var: mullvad_verify.stdout_lines
  when: wg0_conf | length > 0 and mullvad_verify.stdout_lines is defined

- name: Fail if Mullvad not configured
  fail:
    msg: |
      ERROR: Mullvad WireGuard configuration is required.
      Lab VMs access the internet via firewall through Mullvad VPN egress.
      Set MULLVAD_WG_CONF environment variable with your Mullvad WireGuard config.
      See docs/wireguard/WIREGUARD-SETUP.md for setup instructions.
  when: wg0_conf | length == 0 and require_mullvad | bool

- name: Warn if Mullvad not configured
  debug:
    msg: "Mullvad WireGuard not configured; lab egress will use eth0 and public DNS."
  when: wg0_conf | length == 0 and not require_mullvad | bool

- name: Check if WireGuard config exists
  stat:
    path: /etc/wireguard/wg0.conf
  register: wg_conf_file
