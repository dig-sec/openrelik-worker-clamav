---
# NFTables firewall - simple gateway configuration
- name: Enable IP forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes

- name: Configure nftables firewall
  copy:
    dest: /etc/nftables.conf
    mode: '0644'
    content: |
      #!/usr/sbin/nftables -f
      flush ruleset
      
      table inet filter {
        chain input {
          type filter hook input priority 0; policy drop;
          
          # Established connections
          ct state established,related accept
          
          # Loopback
          iif lo accept
          
          # Allow all from host network (vagrant-libvirt management)
          iifname "eth0" ip saddr {{ host_network_cidr }} accept
          
          # All traffic from lab network
          iifname "eth1" accept
        }
        
        chain forward {
          type filter hook forward priority 0; policy drop;
          
          ct state established,related accept
          
          # Lab network -> internet (via eth0 or wg0)
          iifname "eth1" accept
        }
        
        chain output {
          type filter hook output priority 0; policy accept;
        }
      }
      
      table ip nat {
        chain postrouting {
          type nat hook postrouting priority 100; policy accept;
          
          # NAT for lab traffic exiting via eth0 (no VPN)
          oifname "eth0" ip saddr {{ lab_network }} masquerade
          
          # NAT for lab traffic exiting via Mullvad
          oifname "wg0" ip saddr {{ lab_network }} masquerade
        }
      }
  register: nft_config

- name: Enable nftables service
  systemd:
    name: nftables
    enabled: yes
    state: started

- name: Reload nftables rules
  systemd:
    name: nftables
    state: reloaded
  when: nft_config.changed
