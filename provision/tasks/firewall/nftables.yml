---
# NFTables firewall - simple gateway configuration
- name: Enable IP forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes

- name: Configure nftables firewall
  copy:
    dest: /etc/nftables.conf
    mode: '0644'
    content: |
      #!/usr/sbin/nftables -f
      flush ruleset
      
      table inet filter {
        chain input {
          type filter hook input priority 0; policy drop;
          
          # Established connections
          ct state established,related accept
          
          # Loopback
          iif lo accept
          
          # Allow all from host network (vagrant-libvirt management)
          iifname "eth0" ip saddr {{ host_network_cidr }} accept
          
          # All traffic from lab network
          iifname "eth1" accept
        }
        
        chain forward {
          type filter hook forward priority 0; policy drop;
          
          ct state established,related accept
          
          # Lab network -> internet (via eth0 or wg0)
          iifname "eth1" accept

{% if pangolin_enabled | bool %}
          # Allow forwarded Pangolin traffic from host network
          iifname "eth0" oifname "eth1" ip daddr {{ pangolin_ip }} tcp dport {80,443} accept
          iifname "eth0" oifname "eth1" ip daddr {{ pangolin_ip }} udp dport {51820,21820} accept
{% endif %}
        }
        
        chain output {
          type filter hook output priority 0; policy accept;
        }
      }
      
      table ip nat {
        chain prerouting {
          type nat hook prerouting priority -100; policy accept;

{% if pangolin_enabled | bool %}
          iifname "eth0" tcp dport {80,443} dnat to {{ pangolin_ip }}
          iifname "eth0" udp dport {51820,21820} dnat to {{ pangolin_ip }}
{% endif %}
        }

        chain postrouting {
          type nat hook postrouting priority 100; policy accept;
          
          # NAT for lab traffic exiting via Mullvad VPN (required)
          oifname "wg0" ip saddr {{ lab_network }} masquerade
          
          # Fallback NAT via eth0 (only if wg0 is down)
          oifname "eth0" ip saddr {{ lab_network }} masquerade
        }
      }
  register: nft_config

- name: Enable nftables service
  systemd:
    name: nftables
    enabled: yes
    state: started

- name: Reload nftables rules
  systemd:
    name: nftables
    state: reloaded
  when: nft_config.changed
