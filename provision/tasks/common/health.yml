---
# Common health checks for services
- name: Gather service facts
  service_facts:

- name: Assert nginx is running
  assert:
    that:
      - "'nginx.service' in ansible_facts.services"
      - ansible_facts.services['nginx.service'].state == 'running'
  when: health_check_nginx | default(false)

- name: Assert Docker is running
  assert:
    that:
      - "'docker.service' in ansible_facts.services"
      - ansible_facts.services['docker.service'].state == 'running'
  when: health_check_docker | default(false)

- name: Check OpenRelik server health
  uri:
    url: "http://localhost:{{ openrelik_api_port_internal | default(8710) }}/healthz"
    method: GET
    status_code: 200
  register: openrelik_health
  until: openrelik_health.status == 200
  retries: 12
  delay: 5
  when: health_check_openrelik | default(false)

- name: Assert OpenRelik server health
  assert:
    that:
      - openrelik_health.status == 200
  when: health_check_openrelik | default(false)
