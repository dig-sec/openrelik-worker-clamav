---
# Deploy Pangolin access layer
- name: Ensure Pangolin directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ pangolin_install_dir }}"
    - "{{ pangolin_install_dir }}/config"
    - "{{ pangolin_install_dir }}/config/db"
    - "{{ pangolin_install_dir }}/config/logs"
    - "{{ pangolin_install_dir }}/config/traefik"
    - "{{ pangolin_install_dir }}/config/traefik/logs"
    - "{{ pangolin_install_dir }}/config/letsencrypt"

- name: Remove existing Pangolin database (fresh setup)
  file:
    path: "{{ pangolin_install_dir }}/config/db/db.sqlite"
    state: absent

- name: Ensure fresh WireGuard key generation
  file:
    path: "{{ pangolin_install_dir }}/config/key"
    state: absent

- name: Template Pangolin docker-compose.yml
  template:
    src: "{{ playbook_dir }}/templates/pangolin/docker-compose.yml.j2"
    dest: "{{ pangolin_install_dir }}/docker-compose.yml"
    mode: '0644'

- name: Template Pangolin config.yml
  template:
    src: "{{ playbook_dir }}/templates/pangolin/config.yml.j2"
    dest: "{{ pangolin_install_dir }}/config/config.yml"
    mode: '0644'

- name: Template Traefik dynamic config
  template:
    src: "{{ playbook_dir }}/templates/pangolin/traefik_dynamic.yml.j2"
    dest: "{{ pangolin_install_dir }}/config/traefik/dynamic_config.yml"
    mode: '0644'

- name: Template Traefik static config
  template:
    src: "{{ playbook_dir }}/templates/pangolin/traefik_static.yml.j2"
    dest: "{{ pangolin_install_dir }}/config/traefik/traefik_config.yml"
    mode: '0644'

- name: Ensure ACME storage exists
  file:
    path: "{{ pangolin_install_dir }}/config/letsencrypt/acme.json"
    state: touch
    mode: '0600'

- name: Restart Docker daemon to initialize networking
  systemd:
    name: docker
    state: restarted
    enabled: yes

- name: Wait for Docker daemon to be ready
  wait_for:
    path: /var/run/docker.sock
    state: present
    timeout: 30

- name: Start Pangolin services
  shell: |
    cd {{ pangolin_install_dir }}
    docker compose up -d
  args:
    chdir: "{{ pangolin_install_dir }}"
  register: pangolin_up
  changed_when: "'Creating' in pangolin_up.stdout or 'Recreating' in pangolin_up.stdout or 'Starting' in pangolin_up.stdout or 'Pulling' in pangolin_up.stdout"

- name: Display Pangolin access info
  debug:
    msg:
      - "Pangolin deployed to {{ pangolin_bind_ip }}"
      - "Access UI: https://{{ pangolin_domain }}"
      - "WireGuard reachable at: {{ pangolin_domain }}:51820"
