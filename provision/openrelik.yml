---
- name: Install and configure OpenRelik
  hosts: all
  become: yes
  vars:
    openrelik_install_dir: "/opt/openrelik"
    openrelik_user: "vagrant"
    openrelik_client_id: ""
    openrelik_client_secret: ""
    openrelik_allowlist: []
    lab_gateway: "10.20.0.1"
    lab_ip: "10.20.0.30"
    enable_extra_workers: false
    ghcr_username: ""
    ghcr_token: ""
  tasks:
    - name: Configure lab interface (eth1) with static address
      copy:
        dest: /etc/netplan/60-utgard.yaml
        mode: '0644'
        content: |
          network:
            version: 2
            renderer: networkd
            ethernets:
              eth1:
                dhcp4: false
                dhcp6: false
                addresses: [{{ lab_ip }}/24]
                gateway4: {{ lab_gateway }}
                nameservers:
                  addresses: [{{ lab_gateway }}]
      register: lab_netplan

    - name: Apply netplan if lab interface config changed
      when: lab_netplan.changed
      command: netplan apply

    - name: Ensure lab interface is up
      when: lab_netplan.changed
      command: ip link set eth1 up
      changed_when: false

    - name: Set default gateway to firewall (lab network only route)
      shell: |
        ip route del default || true
        ip route add default via {{ lab_gateway }}
      changed_when: false

    - name: Make gateway persistent
      copy:
        dest: /etc/network/if-up.d/lab-gateway
        mode: '0755'
        content: |
          #!/bin/bash
          ip route del default 2>/dev/null || true
          ip route add default via {{ lab_gateway }}

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - ca-certificates
          - curl
          - git
          - gnupg
          - lsb-release
          - python3
          - python3-yaml
        state: present

    - name: Create keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add Docker GPG key
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: Add Docker repository
      shell: |
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
      args:
        creates: /etc/apt/sources.list.d/docker.list

    - name: Update apt cache after adding Docker repo
      apt:
        update_cache: yes

    - name: Install Docker packages
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add vagrant user to docker group
      user:
        name: "{{ openrelik_user }}"
        groups: docker
        append: yes

    - name: Create OpenRelik installation directory
      file:
        path: "{{ openrelik_install_dir }}"
        state: directory
        owner: "{{ openrelik_user }}"
        group: "{{ openrelik_user }}"
        mode: '0755'

    - name: Download OpenRelik install script
      get_url:
        url: https://raw.githubusercontent.com/openrelik/openrelik-deploy/main/docker/install.sh
        dest: "{{ openrelik_install_dir }}/install.sh"
        mode: '0755'
        owner: "{{ openrelik_user }}"
        group: "{{ openrelik_user }}"

    - name: Run OpenRelik install script
      shell: bash install.sh
      args:
        chdir: "{{ openrelik_install_dir }}"
        creates: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
      # Run as root to avoid docker socket permission issues during initial setup
      become_user: "root"

    - name: Point UI to firewall-proxied API endpoint
      lineinfile:
        path: "{{ openrelik_install_dir }}/openrelik/.env"
        regexp: '^OPENRELIK_SERVER_URL='
        line: 'OPENRELIK_SERVER_URL=http://localhost:8710'
      notify: Restart OpenRelik services

    - name: Ensure OpenRelik config directory exists
      file:
        path: "{{ openrelik_install_dir }}/openrelik/config"
        state: directory
        owner: "{{ openrelik_user }}"
        group: "{{ openrelik_user }}"
        mode: '0755'

    - name: Write settings.toml with OAuth (if configured)
      copy:
        dest: "{{ openrelik_install_dir }}/openrelik/config/settings.toml"
        owner: "{{ openrelik_user }}"
        group: "{{ openrelik_user }}"
        mode: '0644'
        content: |
          [oauth]
          client_id = "{{ openrelik_client_id | default('') }}"
          client_secret = "{{ openrelik_client_secret | default('') }}"

          [access]
          allowlist = {{ (openrelik_allowlist | default([])) | to_nice_json }}
      when: (openrelik_client_id | default('')) != '' and (openrelik_client_secret | default('')) != ''

    - name: Note - Local auth will use default Docker credentials
      debug:
        msg:
          - "No OAuth credentials provided."
          - "OpenRelik will use local authentication."
          - "Default credentials: admin / admin (after first startup)"
      when: (openrelik_client_id | default('')) == '' or (openrelik_client_secret | default('')) == ''

    - name: Check if settings.toml exists
      stat:
        path: "{{ openrelik_install_dir }}/openrelik/config/settings.toml"
      register: settings_file

    - name: Create helper script to start OpenRelik
      copy:
        dest: /usr/local/bin/openrelik-start
        mode: '0755'
        content: |
          #!/bin/bash
          cd {{ openrelik_install_dir }}/openrelik
          docker compose up -d
          echo "OpenRelik started!"
          echo "UI: http://localhost:8711/"
          echo "API: http://localhost:8710/api/v1/docs/"

    - name: Create helper script to stop OpenRelik
      copy:
        dest: /usr/local/bin/openrelik-stop
        mode: '0755'
        content: |
          #!/bin/bash
          cd {{ openrelik_install_dir }}/openrelik
          docker compose down
          echo "OpenRelik stopped!"

    - name: Create helper script to view logs
      copy:
        dest: /usr/local/bin/openrelik-logs
        mode: '0755'
        content: |
          #!/bin/bash
          cd {{ openrelik_install_dir }}/openrelik
          docker compose logs -f

    - name: Login to GHCR (if credentials provided)
      when: (ghcr_username | default('')) != '' and (ghcr_token | default('')) != ''
      shell: echo "{{ ghcr_token }}" | docker login ghcr.io -u "{{ ghcr_username }}" --password-stdin

    - name: Disable GHCR-dependent workers when extra workers are not enabled
      when: not (enable_extra_workers | bool)
      shell: |
        python3 << 'EOF'
        import yaml
        compose_file = "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
        with open(compose_file, 'r') as f:
            compose = yaml.safe_load(f)
        services = compose.get('services', {})
        workers = [
            'openrelik-worker-yara',
            'openrelik-worker-hayabusa',
            'openrelik-worker-capa',
            'openrelik-worker-strings',
            'openrelik-worker-entropy',
            'openrelik-worker-eztools',
            'openrelik-worker-exif',
            'openrelik-worker-regripper',
            'openrelik-worker-ssdeep',
            'openrelik-worker-eml',
        'openrelik-worker-clamav',
        'openrelik-worker-grep',
        'openrelik-worker-plaso',
        'openrelik-worker-extraction',
        'openrelik-worker-analyzer-config'
        ]
        removed = []
        for w in workers:
            if w in services:
                services.pop(w)
                removed.append(w)
        compose['services'] = services
        with open(compose_file, 'w') as f:
            yaml.dump(compose, f, default_flow_style=False, sort_keys=False)
        print("Removed workers:", ', '.join(removed))
        EOF

    - name: Start OpenRelik (with or without OAuth config)
      shell: docker compose up -d
      args:
        chdir: "{{ openrelik_install_dir }}/openrelik"
      # Always start - works with or without OAuth config

    - name: Run database migrations (alembic upgrade head)
      shell: docker compose exec -T -w /app/openrelik/datastores/sql openrelik-server /app/.venv/bin/alembic upgrade head
      args:
        chdir: "{{ openrelik_install_dir }}/openrelik"
      register: openrelik_migrate
      retries: 5
      delay: 5
      until: openrelik_migrate.rc == 0

    - name: Generate admin password hash (argon2id) in server container
      when: (openrelik_client_id | default('')) == '' or (openrelik_client_secret | default('')) == ''
      shell: docker compose exec -T openrelik-server /app/.venv/bin/python -c "from argon2 import PasswordHasher; print(PasswordHasher().hash('admin'))"
      args:
        chdir: "{{ openrelik_install_dir }}/openrelik"
      register: openrelik_admin_hash

    - name: Ensure pgcrypto extension exists (for gen_random_uuid)
      when: (openrelik_client_id | default('')) == '' or (openrelik_client_secret | default('')) == ''
      shell: docker compose exec -T openrelik-postgres psql -U openrelik -d openrelik -c "CREATE EXTENSION IF NOT EXISTS pgcrypto;"
      args:
        chdir: "{{ openrelik_install_dir }}/openrelik"

    - name: Check if admin user already exists
      when: (openrelik_client_id | default('')) == '' or (openrelik_client_secret | default('')) == ''
      shell: docker compose exec -T openrelik-postgres psql -U openrelik -d openrelik -t -A -c "SELECT COUNT(*) FROM public.\"user\" WHERE username='admin';"
      args:
        chdir: "{{ openrelik_install_dir }}/openrelik"
      register: openrelik_admin_exists

    - name: Seed default admin user for local auth (admin/admin)
      when: ((openrelik_client_id | default('')) == '' or (openrelik_client_secret | default('')) == '') and ((openrelik_admin_exists.stdout | trim | int) == 0)
      shell: |
        docker compose exec -T openrelik-postgres psql -U openrelik -d openrelik -c "INSERT INTO public.\"user\" (username, display_name, password_hash, password_hash_algorithm, auth_method, uuid, is_active, is_admin, is_robot, is_deleted, is_purged, created_at, updated_at) VALUES ('admin','admin','{{ openrelik_admin_hash.stdout | trim }}','argon2id','local', gen_random_uuid(), true, true, false, false, false, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);"
      args:
        chdir: "{{ openrelik_install_dir }}/openrelik"

    - name: Fix OpenRelik port bindings to allow external access
      shell: |
        cd {{ openrelik_install_dir }}/openrelik
        sed -i 's/127.0.0.1:8710:8710/0.0.0.0:8710:8710/' docker-compose.yml
        sed -i 's/127.0.0.1:8711:8711/0.0.0.0:8711:8711/' docker-compose.yml
      args:
        chdir: "{{ openrelik_install_dir }}/openrelik"

    - name: Add OpenRelik workers (Yara, Hayabusa, Capa, Strings, Entropy, etc.) to docker-compose.yml
      when: enable_extra_workers | bool
      shell: |
        docker_compose_file="{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
        
        # Create a Python script to modify the compose file
        python3 << 'EOF'
        import yaml
        
        compose_file = "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
        
        with open(compose_file, 'r') as f:
            compose = yaml.safe_load(f)
        
        # Add Yara Worker if not present
        if 'openrelik-worker-yara' not in compose.get('services', {}):
            compose['services']['openrelik-worker-yara'] = {
                'container_name': 'openrelik-worker-yara',
                'image': 'ghcr.io/openrelik/openrelik-worker-yara:latest',
                'privileged': True,
                'restart': 'always',
                'environment': ['REDIS_URL=redis://openrelik-redis:6379'],
                'volumes': ['./data:/usr/share/openrelik/data', '/dev:/dev'],
                'depends_on': ['openrelik-redis'],
                'command': 'celery --app=src.app worker --task-events --concurrency=4 --loglevel=INFO -Q openrelik-worker-yara'
            }
            print("Yara worker added")
        
        # Add Hayabusa Worker if not present
        if 'openrelik-worker-hayabusa' not in compose.get('services', {}):
            compose['services']['openrelik-worker-hayabusa'] = {
                'container_name': 'openrelik-worker-hayabusa',
                'image': 'ghcr.io/openrelik/openrelik-worker-hayabusa:latest',
                'restart': 'always',
                'environment': ['REDIS_URL=redis://openrelik-redis:6379'],
                'volumes': ['./data:/usr/share/openrelik/data'],
                'depends_on': ['openrelik-redis'],
                'command': 'celery --app=src.app worker --task-events --concurrency=4 --loglevel=INFO -Q openrelik-worker-hayabusa'
            }
            print("Hayabusa worker added")
        
        # Add Capa Worker if not present
        if 'openrelik-worker-capa' not in compose.get('services', {}):
            compose['services']['openrelik-worker-capa'] = {
                'container_name': 'openrelik-worker-capa',
                'image': 'ghcr.io/openrelik/openrelik-worker-capa:latest',
                'restart': 'always',
                'environment': [
                    'REDIS_URL=redis://openrelik-redis:6379'
                ],
                'volumes': ['./data:/usr/share/openrelik/data'],
                'depends_on': ['openrelik-redis'],
                'command': 'celery --app=src.app worker --task-events --concurrency=4 --loglevel=INFO -Q openrelik-worker-capa'
            }
            print("Capa worker added")
        
        # Add Strings Worker if not present
        if 'openrelik-worker-strings' not in compose.get('services', {}):
            compose['services']['openrelik-worker-strings'] = {
                'container_name': 'openrelik-worker-strings',
                'image': 'ghcr.io/openrelik/openrelik-worker-strings:latest',
                'restart': 'always',
                'environment': ['REDIS_URL=redis://openrelik-redis:6379'],
                'volumes': ['./data:/usr/share/openrelik/data'],
                'depends_on': ['openrelik-redis'],
                'command': 'celery --app=src.app worker --task-events --concurrency=4 --loglevel=INFO -Q openrelik-worker-strings'
            }
            print("Strings worker added")
        
        # Add Entropy Worker if not present
        if 'openrelik-worker-entropy' not in compose.get('services', {}):
            compose['services']['openrelik-worker-entropy'] = {
                'container_name': 'openrelik-worker-entropy',
                'image': 'ghcr.io/openrelik/openrelik-worker-entropy:latest',
                'restart': 'always',
                'environment': ['REDIS_URL=redis://openrelik-redis:6379'],
                'volumes': ['./data:/usr/share/openrelik/data'],
                'depends_on': ['openrelik-redis'],
                'command': 'celery --app=src.app worker --task-events --concurrency=4 --loglevel=INFO -Q openrelik-worker-entropy'
            }
            print("Entropy worker added")
        
        # Add EZTools Worker if not present
        if 'openrelik-worker-eztools' not in compose.get('services', {}):
            compose['services']['openrelik-worker-eztools'] = {
                'container_name': 'openrelik-worker-eztools',
                'image': 'ghcr.io/openrelik/openrelik-worker-eztools:latest',
                'restart': 'always',
                'environment': ['REDIS_URL=redis://openrelik-redis:6379', 'OPENRELIK_PYDEBUG=0'],
                'volumes': ['./data:/usr/share/openrelik/data'],
                'depends_on': ['openrelik-redis'],
                'command': 'celery --app=src.app worker --task-events --concurrency=4 --loglevel=INFO -Q openrelik-worker-eztools'
            }
            print("EZTools worker added")
        
        # Add Exif Worker if not present
        if 'openrelik-worker-exif' not in compose.get('services', {}):
            compose['services']['openrelik-worker-exif'] = {
                'container_name': 'openrelik-worker-exif',
                'image': 'ghcr.io/openrelik/openrelik-worker-exif:latest',
                'restart': 'always',
                'environment': ['REDIS_URL=redis://openrelik-redis:6379', 'OPENRELIK_PYDEBUG=0'],
                'volumes': ['./data:/usr/share/openrelik/data'],
                'depends_on': ['openrelik-redis'],
                'command': 'celery --app=src.app worker --task-events --concurrency=4 --loglevel=INFO -Q openrelik-worker-exif'
            }
            print("Exif worker added")
        
        # Add RegRipper Worker if not present
        if 'openrelik-worker-regripper' not in compose.get('services', {}):
            compose['services']['openrelik-worker-regripper'] = {
                'container_name': 'openrelik-worker-regripper',
                'image': 'ghcr.io/openrelik/openrelik-worker-regripper:latest',
                'restart': 'always',
                'environment': ['REDIS_URL=redis://openrelik-redis:6379', 'OPENRELIK_PYDEBUG=0'],
                'volumes': ['./data:/usr/share/openrelik/data'],
                'depends_on': ['openrelik-redis'],
                'command': 'celery --app=src.app worker --task-events --concurrency=2 --loglevel=INFO -Q openrelik-worker-regripper'
            }
            print("RegRipper worker added")
        
        # Add SSDeep Worker if not present
        if 'openrelik-worker-ssdeep' not in compose.get('services', {}):
            compose['services']['openrelik-worker-ssdeep'] = {
                'container_name': 'openrelik-worker-ssdeep',
                'image': 'ghcr.io/openrelik/openrelik-worker-ssdeep:latest',
                'restart': 'always',
                'environment': ['REDIS_URL=redis://openrelik-redis:6379', 'OPENRELIK_PYDEBUG=0'],
                'volumes': ['./data:/usr/share/openrelik/data'],
                'depends_on': ['openrelik-redis'],
                'command': 'celery --app=src.app worker --task-events --concurrency=4 --loglevel=INFO -Q openrelik-worker-ssdeep'
            }
            print("SSDeep worker added")
        
        # Add EML Worker if not present
        if 'openrelik-worker-eml' not in compose.get('services', {}):
            compose['services']['openrelik-worker-eml'] = {
                'container_name': 'openrelik-worker-eml',
                'image': 'ghcr.io/openrelik/openrelik-worker-eml:latest',
                'restart': 'always',
                'environment': ['REDIS_URL=redis://openrelik-redis:6379', 'OPENRELIK_PYDEBUG=0'],
                'volumes': ['./data:/usr/share/openrelik/data'],
                'depends_on': ['openrelik-redis'],
                'command': 'celery --app=src.app worker --task-events --concurrency=4 --loglevel=INFO -Q openrelik-worker-eml'
            }
            print("EML worker added")
        
        # Add ClamAV Worker if not present
        if 'openrelik-worker-clamav' not in compose.get('services', {}):
            compose['services']['openrelik-worker-clamav'] = {
                'container_name': 'openrelik-worker-clamav',
                'image': 'ghcr.io/julianghill/openrelik-worker-clamav:latest',
                'restart': 'always',
                'environment': ['REDIS_URL=redis://openrelik-redis:6379', 'OPENRELIK_PYDEBUG=0'],
                'volumes': ['./data:/usr/share/openrelik/data'],
                'depends_on': ['openrelik-redis'],
                'command': 'celery --app=src.app worker --task-events --concurrency=4 --loglevel=INFO -Q openrelik-worker-clamav'
            }
            print("ClamAV worker added")
        
        with open(compose_file, 'w') as f:
            yaml.dump(compose, f, default_flow_style=False, sort_keys=False)
        
        print("docker-compose.yml updated successfully")
        EOF
      args:
        chdir: "{{ openrelik_install_dir }}/openrelik"

    - name: Restart OpenRelik services to include workers
      shell: docker compose down && docker compose up -d
      args:
        chdir: "{{ openrelik_install_dir }}/openrelik"

    - name: Wait for OpenRelik services to be ready
      wait_for:
        timeout: 15

    - name: Apply JSONDecodeError patch to all workers
      shell: |
        # List of workers that need the patch
        WORKERS=(
          "openrelik-worker-capa"
          "openrelik-worker-yara"
          "openrelik-worker-entropy"
          "openrelik-worker-analyzer-config"
          "openrelik-worker-strings"
          "openrelik-worker-hayabusa"
          "openrelik-worker-plaso"
          "openrelik-worker-extraction"
          "openrelik-worker-grep"
          "openrelik-worker-eztools"
          "openrelik-worker-exif"
          "openrelik-worker-regripper",
          "openrelik-worker-ssdeep",
          "openrelik-worker-eml",
          "openrelik-worker-clamav"
        )
        
        for worker in "${WORKERS[@]}"; do
          # Check if worker container exists
          if docker ps -a | grep -q "$worker"; then
            echo "Patching $worker..."
            # Copy patch script
            docker cp {{ openrelik_install_dir }}/../patches/apply-task-utils-fix.py "$worker:/tmp/" 2>/dev/null || true
            # Apply patch
            docker exec "$worker" python3 /tmp/apply-task-utils-fix.py 2>/dev/null || echo "  âœ“ Already patched or not applicable"
          fi
        done
        echo "Patch application complete"
      args:
        chdir: "{{ openrelik_install_dir }}/openrelik"
      ignore_errors: yes

    - name: Bootstrap Yara rules from signature-base repository
      shell: |
        mkdir -p {{ openrelik_install_dir }}/openrelik/data/yara
        if [ ! -d {{ openrelik_install_dir }}/openrelik/data/yara/signature-base ]; then
          git clone --depth 1 https://github.com/Neo23x0/signature-base.git {{ openrelik_install_dir }}/openrelik/data/yara/signature-base
        else
          cd {{ openrelik_install_dir }}/openrelik/data/yara/signature-base && git pull origin master
        fi
      args:
        chdir: "{{ openrelik_install_dir }}/openrelik"

    - name: Verify admin user password is correct
      when: (openrelik_client_id | default('')) == '' or (openrelik_client_secret | default('')) == ''
      shell: |
        # Generate fresh hash
        HASH=$(docker compose exec -T openrelik-server /app/.venv/bin/python -c "from argon2 import PasswordHasher; print(PasswordHasher().hash('admin'))")
        # Update password
        docker compose exec -T openrelik-postgres psql -U openrelik -d openrelik -c "UPDATE public.\"user\" SET password_hash = '$HASH' WHERE username='admin';"
      args:
        chdir: "{{ openrelik_install_dir }}/openrelik"

    - name: Display final instructions
      debug:
        msg:
          - "================================================"
          - "Helpful commands:"
          - "  openrelik-start - Start OpenRelik services"
          - "  openrelik-stop  - Stop OpenRelik services"
          - "  openrelik-logs  - View OpenRelik logs"
          - "================================================"
          - ""
          - "OpenRelik Workers Added:"
          - "  - Yara Worker: Scans files/folders with Yara rules"
          - "    (Requires privileged mode and /dev access for disk images)"
          - "    * Pre-loaded rules: /usr/share/openrelik/data/yara/signature-base/"
          - "    * Use this path in the Yara worker folder path input field"
          - "  - Hayabusa Worker: Event log analysis tool"
          - "  - Capa Worker: Identifies capabilities in executable files"
          - "  - Strings Worker: Extracts strings from binary files"
          - "  - Entropy Worker: Calculates file entropy and identifies high-entropy files"
          - "  - EZTools Worker: Eric Zimmerman's forensic tools (LECmd, RBCmd, AppCompatCacheParser)"
          - "  - Exif Worker: Extracts EXIF metadata from image files"
          - "  - RegRipper Worker: Analyzes Windows registry hive files"
          - "  - SSDeep Worker: Fuzzy file hashing using context-triggered piecewise hashes"
          - "  - EML Worker: Parses EML and MSG email files, extracts metadata and attachments"
          - "  - ClamAV Worker: Antivirus scanning of files and Velociraptor collections with detections reporting"

  handlers:
    - name: Restart OpenRelik services
      shell: docker compose down && docker compose up -d
      args:
        chdir: "{{ openrelik_install_dir }}/openrelik"
