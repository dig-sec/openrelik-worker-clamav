# Utgard OSINT Platform - Main Portal Reverse Proxy
# Routes all services through a single HTTPS endpoint or subdomains
# Managed by Ansible - do not edit manually
# External hostname: {{ edge_external_hostname }}
# Subdomain routing: {{ edge_use_subdomains }}
# Authentication: {% if edge_auth_enabled | default(false) %}Enabled{% else %}Disabled{% endif %}

map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

{% if edge_use_subdomains %}
# ============================================================================
# SUBDOMAIN-BASED ROUTING
# ============================================================================
# Each service runs on its own subdomain

# Main portal - root domain
server {
    listen 443 ssl http2;
    server_name {{ edge_external_hostname }};

    ssl_certificate {{ portal_tls_cert_path }};
    ssl_certificate_key {{ portal_tls_key_path }};
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    root {{ portal_web_root }};
    index index.html;

    location = / {
{% if edge_auth_enabled | default(false) and edge_auth_protect_landing | default(false) %}
        # Authentication required for landing page (with IP whitelist bypass)
        satisfy any;
        allow 62.109.37.98;
        allow 78.71.168.138;
        allow 193.182.188.33;
        deny all;
        
        auth_basic "Utgard OSINT Platform";
        auth_basic_user_file /opt/guacamole/auth/.htpasswd;
{% endif %}
        try_files /index.html =404;
    }
}

# Guacamole subdomain
{% if portal_services.guacamole | default(true) %}
server {
    listen 443 ssl http2;
    server_name {{ edge_service_subdomains.guacamole | default('guacamole') }}.{{ edge_external_hostname }};

    ssl_certificate {{ portal_tls_cert_path }};
    ssl_certificate_key {{ portal_tls_key_path }};
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        proxy_pass http://127.0.0.1:{{ portal_service_endpoints.guacamole.port }}/guacamole/;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 3600;
    }
}
{% endif %}

# OpenRelik subdomain
{% if portal_services.openrelik | default(true) %}
server {
    listen 443 ssl http2;
    server_name {{ edge_service_subdomains.openrelik | default('openrelik') }}.{{ edge_external_hostname }};

    ssl_certificate {{ portal_tls_cert_path }};
    ssl_certificate_key {{ portal_tls_key_path }};
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Auth endpoints go to the API service (UI is static and returns 405 for POST)
    location /auth/ {
        proxy_pass http://127.0.0.1:{{ portal_service_endpoints.openrelik.api_port }}/auth/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_read_timeout 3600;
    }

    # UI
    location / {
        proxy_pass http://127.0.0.1:{{ portal_service_endpoints.openrelik.ui_port }}/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_read_timeout 3600;
    }

    # API
    location /api/ {
        proxy_pass http://127.0.0.1:{{ portal_service_endpoints.openrelik.api_port }}/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_read_timeout 3600;
        client_max_body_size 10G;
    }
}
{% endif %}

# Maigret subdomain
{% if portal_services.maigret | default(true) %}
server {
    listen 443 ssl http2;
    server_name {{ edge_service_subdomains.maigret | default('maigret') }}.{{ edge_external_hostname }};

    ssl_certificate {{ portal_tls_cert_path }};
    ssl_certificate_key {{ portal_tls_key_path }};
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        satisfy any;
        allow 62.109.37.98;
        allow 78.71.168.138;
        allow 193.182.188.33;
        deny all;
        
        auth_basic "Utgard OSINT Platform - Maigret";
        auth_basic_user_file /opt/guacamole/auth/.htpasswd;
        
        proxy_pass http://127.0.0.1:{{ portal_service_endpoints.maigret.port }}/;
    }
}
{% endif %}

# Kasm Tor subdomain
{% if portal_services.kasm | default(true) %}
server {
    listen 443 ssl http2;
    server_name {{ edge_service_subdomains.kasm_tor | default('tor') }}.{{ edge_external_hostname }};

    ssl_certificate {{ portal_tls_cert_path }};
    ssl_certificate_key {{ portal_tls_key_path }};
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        proxy_pass https://127.0.0.1:{{ portal_service_endpoints.kasm.port }}/tor/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_read_timeout 3600;
        proxy_ssl_verify off;
    }
}
{% endif %}

# Kasm subdomain
{% if portal_services.kasm | default(true) %}
server {
    listen 443 ssl http2;
    server_name {{ edge_service_subdomains.kasm | default('browsers') }}.{{ edge_external_hostname }};

    ssl_certificate {{ portal_tls_cert_path }};
    ssl_certificate_key {{ portal_tls_key_path }};
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        proxy_pass https://127.0.0.1:{{ portal_service_endpoints.kasm.port }}/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_read_timeout 3600;
        proxy_ssl_verify off;
    }
}
{% endif %}


{% else %}
# ============================================================================
# PATH-BASED ROUTING (DEFAULT)
# ============================================================================
# All services on same domain with path prefixes

server {
    listen 443 ssl http2;
    server_name _;

    ssl_certificate {{ portal_tls_cert_path }};
    ssl_certificate_key {{ portal_tls_key_path }};
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Portal landing page
    root {{ portal_web_root }};
    index index.html;

{% if edge_auth_enabled | default(false) and edge_auth_protect_landing | default(false) %}
    auth_basic "Utgard OSINT Platform";
    auth_basic_user_file /opt/guacamole/auth/.htpasswd;
{% endif %}

    location = / {
        try_files /index.html =404;
    }

    # Guacamole remote desktop gateway
{% if portal_services.guacamole | default(true) %}
    location = /guacamole {
        return 301 /guacamole/;
    }

    location /guacamole/ {
        proxy_pass http://127.0.0.1:{{ portal_service_endpoints.guacamole.port }}/guacamole/;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 3600;
    }
{% endif %}

    # Maigret username OSINT search
{% if portal_services.maigret | default(true) %}
    location /maigret/ {
        satisfy any;
        allow all;
        
        auth_basic "Utgard OSINT Platform - Maigret";
        auth_basic_user_file /opt/guacamole/auth/.htpasswd;
        
        proxy_pass http://127.0.0.1:{{ portal_service_endpoints.maigret.port }}/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_read_timeout 300;
    }
{% endif %}

    # Kasm isolated browsers
{% if portal_services.kasm | default(true) %}
    location = /kasm {
        return 301 /kasm/;
    }
    
    location /kasm/ {
        return 302 https://$host:{{ portal_service_endpoints.kasm.port }}/;
    }
{% endif %}
}

{% endif %}

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name _;
    return 301 https://$host$request_uri;
}
