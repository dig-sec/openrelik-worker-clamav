---
# Guacamole installation (Docker-based)

- name: Ensure Guacamole state directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ guacamole_state_dir }}"
    - "{{ guacamole_state_dir }}/initdb"
    - "{{ guacamole_state_dir }}/postgres"

- name: Ensure Guacamole secrets directory
  file:
    path: "{{ guacamole_state_dir }}/secrets"
    state: directory
    mode: '0700'

- name: Ensure OpenSSL is installed
  package:
    name: openssl
    state: present

- name: Use provided Guacamole DB password
  set_fact:
    guacamole_db_password_resolved: "{{ guacamole_db_password }}"
  when: guacamole_db_password | length > 0

- name: Check stored Guacamole DB password
  stat:
    path: "{{ guacamole_db_password_file }}"
  register: guacamole_db_password_stat
  when: guacamole_db_password | length == 0

- name: Generate Guacamole DB password
  command: openssl rand -hex 16
  register: guacamole_db_password_gen
  when:
    - guacamole_db_password | length == 0
    - not guacamole_db_password_stat.stat.exists

- name: Store Guacamole DB password
  copy:
    dest: "{{ guacamole_db_password_file }}"
    content: "{{ guacamole_db_password_gen.stdout }}"
    mode: '0600'
  when:
    - guacamole_db_password | length == 0
    - not guacamole_db_password_stat.stat.exists

- name: Read stored Guacamole DB password
  slurp:
    path: "{{ guacamole_db_password_file }}"
  register: guacamole_db_password_slurp
  when: guacamole_db_password | length == 0

- name: Set resolved Guacamole DB password
  set_fact:
    guacamole_db_password_resolved: "{{ guacamole_db_password_slurp.content | b64decode | trim }}"
  when: guacamole_db_password | length == 0

- name: Check if valid Guacamole database schema exists
  command: grep -q "CREATE TABLE guacamole_user" {{ guacamole_initdb_path }}
  register: guacamole_schema_check
  failed_when: false
  changed_when: false

- name: Generate Guacamole database schema
  shell: >
    docker run --rm {{ guacamole_guacamole_image }}
    /opt/guacamole/bin/initdb.sh --postgresql > {{ guacamole_initdb_path }}
  when: guacamole_schema_check.rc != 0

- name: Verify Guacamole database schema was generated correctly
  command: grep -q "CREATE TABLE guacamole_user" {{ guacamole_initdb_path }}
  changed_when: false

- name: Render Guacamole docker-compose
  template:
    src: docker-compose.yml.j2
    dest: "{{ guacamole_state_dir }}/docker-compose.yml"
    mode: '0644'
  register: guacamole_compose_render

- name: Check if PostgreSQL data exists
  stat:
    path: "{{ guacamole_state_dir }}/postgres/PG_VERSION"
  register: postgres_data_exists

- name: Remove old PostgreSQL data if docker-compose changed
  file:
    path: "{{ guacamole_state_dir }}/postgres"
    state: absent
  when:
    - guacamole_compose_render.changed
    - postgres_data_exists.stat.exists

- name: Recreate PostgreSQL data directory
  file:
    path: "{{ guacamole_state_dir }}/postgres"
    state: directory
    mode: '0755'
  when:
    - guacamole_compose_render.changed
    - postgres_data_exists.stat.exists

- name: Start Guacamole
  command: docker compose up -d
  args:
    chdir: "{{ guacamole_state_dir }}"
  register: guacamole_up
  changed_when: "'Created' in guacamole_up.stderr or 'Started' in guacamole_up.stderr"

- name: Wait for PostgreSQL to be ready
  command: >
    docker compose exec -T guacamole-db
    pg_isready -U {{ guacamole_db_user }} -d {{ guacamole_db_name }}
  args:
    chdir: "{{ guacamole_state_dir }}"
  register: postgres_ready
  until: postgres_ready.rc == 0
  retries: 30
  delay: 2
  changed_when: false

- name: Check if database tables exist
  command: >
    docker compose exec -T guacamole-db
    psql -U {{ guacamole_db_user }} -d {{ guacamole_db_name }}
    -tAc "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public' AND table_name='guacamole_user'"
  args:
    chdir: "{{ guacamole_state_dir }}"
  register: guacamole_tables_check
  changed_when: false

- name: Initialize Guacamole database schema if needed
  command: >
    docker compose exec -T guacamole-db
    psql -U {{ guacamole_db_user }} -d {{ guacamole_db_name }}
  args:
    stdin: "{{ lookup('file', guacamole_initdb_path) }}"
    chdir: "{{ guacamole_state_dir }}"
  when: guacamole_tables_check.stdout == "0"

- name: Restart Guacamole application if database was initialized
  command: docker compose restart guacamole
  args:
    chdir: "{{ guacamole_state_dir }}"
  when: guacamole_tables_check.stdout == "0"

- name: Show Guacamole container status
  command: docker compose ps
  args:
    chdir: "{{ guacamole_state_dir }}"
  register: guacamole_ps
  changed_when: false

- name: Display Guacamole status
  debug:
    msg: "{{ guacamole_ps.stdout_lines }}"
