---
# OpenRelik installation using official install script

- name: Create OpenRelik directory
  file:
    path: "{{ openrelik_install_dir }}"
    state: directory
    mode: '0755'

- name: Load external access configuration
  include_vars:
    file: /home/azureuser/git/utgard/config.yml
    name: config_vars
  register: openrelik_config_load
  failed_when: false

- name: Derive external access variables
  set_fact:
    openrelik_external_hostname: "{{ config_vars.external_access.hostname | default('localhost') }}"
    openrelik_use_subdomains: "{{ config_vars.external_access.use_subdomains | default(false) }}"
    openrelik_service_subdomain: "{{ config_vars.external_access.service_subdomains.openrelik | default('forensics') }}"
  when: openrelik_config_load is not failed

- name: Compute OpenRelik server URL (HTTPS via edge)
  set_fact:
    openrelik_server_url: >-
      {{
        (
          openrelik_use_subdomains
          | ternary(
              'https://' ~ openrelik_service_subdomain ~ '.' ~ openrelik_external_hostname,
              'https://' ~ openrelik_external_hostname ~ '/openrelik'
          )
        )
      }}
  when: openrelik_config_load is not failed

- name: Check if OpenRelik is already installed
  stat:
    path: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
  register: openrelik_compose_pre

- name: Download OpenRelik install script
  get_url:
    url: https://raw.githubusercontent.com/openrelik/openrelik-deploy/main/docker/install.sh
    dest: "{{ openrelik_install_dir }}/install.sh"
    mode: '0755'
  when: not openrelik_compose_pre.stat.exists

- name: Run OpenRelik install script
  command: ./install.sh
  args:
    chdir: "{{ openrelik_install_dir }}"
  when: not openrelik_compose_pre.stat.exists
  register: openrelik_install

- name: Refresh OpenRelik compose status
  stat:
    path: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
  register: openrelik_compose

- name: Set OpenRelik server URL for UI
  lineinfile:
    path: "{{ openrelik_install_dir }}/openrelik/config.env"
    regexp: '^OPENRELIK_SERVER_URL='
    line: "OPENRELIK_SERVER_URL={{ openrelik_server_url | default('https://' ~ (openrelik_external_hostname | default('localhost')) ~ '/openrelik') }}"
  when:
    - openrelik_compose.stat.exists
  register: openrelik_set_url

- name: Remove stray OpenRelik API bindings
  lineinfile:
    path: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
    regexp: '^\\s*- 0\\.0\\.0\\.0:8710:8710$'
    state: absent
  when:
    - openrelik_compose.stat.exists

- name: Remove stray OpenRelik UI bindings
  lineinfile:
    path: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
    regexp: '^\\s*- 0\\.0\\.0\\.0:8711:8711$'
    state: absent
  when:
    - openrelik_compose.stat.exists

- name: Update OpenRelik API binding
  replace:
    path: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
    regexp: '127\\.0\\.0\\.1:8710:8710'
    replace: "0.0.0.0:{{ openrelik_api_port }}:8710"
  when:
    - openrelik_compose.stat.exists

- name: Update OpenRelik UI binding
  replace:
    path: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
    regexp: '127\\.0\\.0\\.1:8711:8711'
    replace: "0.0.0.0:{{ openrelik_ui_port }}:8711"
  when:
    - openrelik_compose.stat.exists

- name: Read OpenRelik compose file
  slurp:
    path: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
  register: openrelik_compose_body
  when:
    - openrelik_compose.stat.exists

- name: Derive existing OpenRelik workers
  set_fact:
    openrelik_existing_workers: >-
      {{ (openrelik_compose_body.content | b64decode)
         | regex_findall('(?m)^\\s*(openrelik-worker-[a-z0-9-]+):\\s*$')
         | unique }}
  when:
    - openrelik_compose.stat.exists

- name: Resolve extra OpenRelik workers
  set_fact:
    openrelik_extra_workers_resolved: >-
      {{ openrelik_extra_workers
         | rejectattr('service', 'in', openrelik_existing_workers | default([]))
         | list }}
  when:
    - openrelik_compose.stat.exists

- name: Login to OpenRelik registry (optional)
  command: docker login {{ openrelik_registry_url }} -u {{ openrelik_registry_username }} --password-stdin
  args:
    stdin: "{{ openrelik_registry_password }}"
  register: openrelik_registry_login
  changed_when: "'Login Succeeded' in openrelik_registry_login.stdout"
  when:
    - openrelik_compose.stat.exists
    - openrelik_registry_username | length > 0
    - openrelik_registry_password | length > 0

- name: Check OpenRelik worker images
  command: "docker manifest inspect {{ openrelik_worker_registry }}/{{ item.service }}:{{ item.tag | default(openrelik_worker_tag) }}"
  register: openrelik_worker_manifest
  changed_when: false
  failed_when: false
  loop: "{{ openrelik_extra_workers_resolved | default(openrelik_extra_workers) }}"
  when:
    - openrelik_compose.stat.exists
    - (openrelik_extra_workers_resolved | default(openrelik_extra_workers) | length) > 0

- name: Collect missing OpenRelik workers
  set_fact:
    openrelik_missing_workers: >-
      {{ openrelik_worker_manifest.results
         | rejectattr('rc', 'equalto', 0)
         | map(attribute='item.service')
         | list }}
  when:
    - openrelik_compose.stat.exists
    - openrelik_worker_manifest is defined

- name: Fail when OpenRelik worker images are missing
  fail:
    msg: >-
      Missing or denied OpenRelik worker images: {{ openrelik_missing_workers | join(', ') }}.
      Provide tags/registry auth or set openrelik_skip_missing_workers: true to skip unavailable workers.
  when:
    - openrelik_compose.stat.exists
    - openrelik_missing_workers is defined
    - openrelik_missing_workers | length > 0
    - not openrelik_skip_missing_workers | default(false)

- name: Filter OpenRelik workers to available images
  set_fact:
    openrelik_extra_workers_resolved: >-
      {{ openrelik_worker_manifest.results
         | selectattr('rc', 'equalto', 0)
         | map(attribute='item')
         | list }}
  when:
    - openrelik_compose.stat.exists
    - openrelik_worker_manifest is defined
    - openrelik_skip_missing_workers | default(false)

- name: Render OpenRelik extra worker compose
  template:
    src: extra-workers.yml.j2
    dest: "{{ openrelik_install_dir }}/openrelik/docker-compose.extra-workers.yml"
    mode: '0644'
  when:
    - openrelik_compose.stat.exists

- name: Ensure OpenRelik containers are running
  command: >
    docker compose
      -f docker-compose.yml
      -f docker-compose.extra-workers.yml
      up -d
  args:
    chdir: "{{ openrelik_install_dir }}/openrelik"
  register: openrelik_start
  changed_when: "'Started' in openrelik_start.stderr or 'Created' in openrelik_start.stderr"
  when:
    - openrelik_compose.stat.exists

- name: Restart OpenRelik stack if URL changed
  command: >
    docker compose
      -f docker-compose.yml
      -f docker-compose.extra-workers.yml
      up -d
  args:
    chdir: "{{ openrelik_install_dir }}/openrelik"
  when:
    - openrelik_compose.stat.exists
    - openrelik_set_url is defined and openrelik_set_url.changed

- name: Wait for OpenRelik UI to be ready
  uri:
    url: "http://localhost:{{ openrelik_ui_port }}"
    status_code: 200
  register: openrelik_health
  retries: 30
  delay: 10
  until: openrelik_health.status == 200
  when:
    - openrelik_compose.stat.exists

- name: Wait for OpenRelik API to be ready
  uri:
    url: "http://localhost:{{ openrelik_api_port }}/"
    status_code: [200, 404]
  register: openrelik_api_health
  retries: 10
  delay: 5
  until: openrelik_api_health.status in [200, 404]
  when:
    - openrelik_compose.stat.exists

- name: Show OpenRelik container status
  command: >
    docker compose
      -f docker-compose.yml
      -f docker-compose.extra-workers.yml
      ps
  args:
    chdir: "{{ openrelik_install_dir }}/openrelik"
  register: openrelik_ps
  changed_when: false
  when:
    - openrelik_compose.stat.exists

- name: Display OpenRelik status
  debug:
    msg: "{{ openrelik_ps.stdout_lines }}"
  when:
    - openrelik_compose.stat.exists

- name: Ensure artifact directories exist for database folders
  shell: |
    docker compose exec -T openrelik-postgres psql -U openrelik -d openrelik -t -c "SELECT uuid FROM folder WHERE deleted_at IS NULL;" | \
    while read -r uuid; do
      uuid_clean=$(echo "$uuid" | tr -d '- ')
      if [ -n "$uuid_clean" ]; then
        mkdir -p "{{ openrelik_install_dir }}/openrelik/data/artifacts/${uuid_clean}"
        chmod 777 "{{ openrelik_install_dir }}/openrelik/data/artifacts/${uuid_clean}"
      fi
    done
  args:
    chdir: "{{ openrelik_install_dir }}/openrelik"
  register: openrelik_artifact_dirs
  changed_when: false
  failed_when: false
  when:
    - openrelik_compose.stat.exists
