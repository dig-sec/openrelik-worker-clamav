---
# OpenRelik installation using official install script

- name: Create OpenRelik directory
  file:
    path: "{{ openrelik_install_dir }}"
    state: directory
    mode: '0755'

- name: Check if OpenRelik is already installed
  stat:
    path: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
  register: openrelik_compose_pre

- name: Download OpenRelik install script
  get_url:
    url: https://raw.githubusercontent.com/openrelik/openrelik-deploy/main/docker/install.sh
    dest: "{{ openrelik_install_dir }}/install.sh"
    mode: '0755'
  when: not openrelik_compose_pre.stat.exists

- name: Run OpenRelik install script
  command: ./install.sh
  args:
    chdir: "{{ openrelik_install_dir }}"
  when: not openrelik_compose_pre.stat.exists
  register: openrelik_install

- name: Refresh OpenRelik compose status
  stat:
    path: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
  register: openrelik_compose

- name: Set OpenRelik server URL for UI
  lineinfile:
    path: "{{ openrelik_install_dir }}/openrelik/config.env"
    regexp: '^OPENRELIK_SERVER_URL='
    line: "OPENRELIK_SERVER_URL=http://{{ host_public_ip | default('127.0.0.1') }}:{{ openrelik_api_port }}"
  when:
    - openrelik_compose.stat.exists

- name: Remove stray OpenRelik API bindings
  lineinfile:
    path: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
    regexp: '^\\s*- 0\\.0\\.0\\.0:8710:8710$'
    state: absent
  when:
    - openrelik_compose.stat.exists

- name: Remove stray OpenRelik UI bindings
  lineinfile:
    path: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
    regexp: '^\\s*- 0\\.0\\.0\\.0:8711:8711$'
    state: absent
  when:
    - openrelik_compose.stat.exists

- name: Update OpenRelik API binding
  replace:
    path: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
    regexp: '127\\.0\\.0\\.1:8710:8710'
    replace: "0.0.0.0:{{ openrelik_api_port }}:8710"
  when:
    - openrelik_compose.stat.exists

- name: Update OpenRelik UI binding
  replace:
    path: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
    regexp: '127\\.0\\.0\\.1:8711:8711'
    replace: "0.0.0.0:{{ openrelik_ui_port }}:8711"
  when:
    - openrelik_compose.stat.exists

- name: Read OpenRelik compose file
  slurp:
    path: "{{ openrelik_install_dir }}/openrelik/docker-compose.yml"
  register: openrelik_compose_body
  when:
    - openrelik_compose.stat.exists

- name: Derive existing OpenRelik workers
  set_fact:
    openrelik_existing_workers: >-
      {{ (openrelik_compose_body.content | b64decode)
         | regex_findall('(?m)^\\s*(openrelik-worker-[a-z0-9-]+):\\s*$')
         | unique }}
  when:
    - openrelik_compose.stat.exists

- name: Resolve extra OpenRelik workers
  set_fact:
    openrelik_extra_workers_resolved: >-
      {{ openrelik_extra_workers
         | rejectattr('service', 'in', openrelik_existing_workers | default([]))
         | list }}
  when:
    - openrelik_compose.stat.exists

- name: Login to OpenRelik registry (optional)
  command: docker login {{ openrelik_registry_url }} -u {{ openrelik_registry_username }} --password-stdin
  args:
    stdin: "{{ openrelik_registry_password }}"
  register: openrelik_registry_login
  changed_when: "'Login Succeeded' in openrelik_registry_login.stdout"
  when:
    - openrelik_compose.stat.exists
    - openrelik_registry_username | length > 0
    - openrelik_registry_password | length > 0

- name: Check OpenRelik worker images
  command: "docker manifest inspect {{ openrelik_worker_registry }}/{{ item.service }}:{{ item.tag | default(openrelik_worker_tag) }}"
  register: openrelik_worker_manifest
  changed_when: false
  failed_when: false
  loop: "{{ openrelik_extra_workers_resolved | default(openrelik_extra_workers) }}"
  when:
    - openrelik_compose.stat.exists
    - (openrelik_extra_workers_resolved | default(openrelik_extra_workers) | length) > 0

- name: Collect missing OpenRelik workers
  set_fact:
    openrelik_missing_workers: >-
      {{ openrelik_worker_manifest.results
         | rejectattr('rc', 'equalto', 0)
         | map(attribute='item.service')
         | list }}
  when:
    - openrelik_compose.stat.exists
    - openrelik_worker_manifest is defined

- name: Fail when OpenRelik worker images are missing
  fail:
    msg: >-
      Missing or denied OpenRelik worker images: {{ openrelik_missing_workers | join(', ') }}.
      Provide tags/registry auth or set openrelik_skip_missing_workers: true to skip unavailable workers.
  when:
    - openrelik_compose.stat.exists
    - openrelik_missing_workers is defined
    - openrelik_missing_workers | length > 0
    - not openrelik_skip_missing_workers | default(false)

- name: Filter OpenRelik workers to available images
  set_fact:
    openrelik_extra_workers_resolved: >-
      {{ openrelik_worker_manifest.results
         | selectattr('rc', 'equalto', 0)
         | map(attribute='item')
         | list }}
  when:
    - openrelik_compose.stat.exists
    - openrelik_worker_manifest is defined
    - openrelik_skip_missing_workers | default(false)

- name: Render OpenRelik extra worker compose
  template:
    src: extra-workers.yml.j2
    dest: "{{ openrelik_install_dir }}/openrelik/docker-compose.extra-workers.yml"
    mode: '0644'
  when:
    - openrelik_compose.stat.exists

- name: Ensure OpenRelik containers are running
  command: >
    docker compose
      -f docker-compose.yml
      -f docker-compose.extra-workers.yml
      up -d
  args:
    chdir: "{{ openrelik_install_dir }}/openrelik"
  register: openrelik_start
  changed_when: "'Started' in openrelik_start.stderr or 'Created' in openrelik_start.stderr"
  when:
    - openrelik_compose.stat.exists

- name: Wait for OpenRelik UI to be ready
  uri:
    url: "http://localhost:{{ openrelik_ui_port }}"
    status_code: 200
  register: openrelik_health
  retries: 30
  delay: 10
  until: openrelik_health.status == 200
  when:
    - openrelik_compose.stat.exists

- name: Wait for OpenRelik API to be ready
  uri:
    url: "http://localhost:{{ openrelik_api_port }}/"
    status_code: [200, 404]
  register: openrelik_api_health
  retries: 10
  delay: 5
  until: openrelik_api_health.status in [200, 404]
  when:
    - openrelik_compose.stat.exists

- name: Show OpenRelik container status
  command: >
    docker compose
      -f docker-compose.yml
      -f docker-compose.extra-workers.yml
      ps
  args:
    chdir: "{{ openrelik_install_dir }}/openrelik"
  register: openrelik_ps
  changed_when: false
  when:
    - openrelik_compose.stat.exists

- name: Display OpenRelik status
  debug:
    msg: "{{ openrelik_ps.stdout_lines }}"
  when:
    - openrelik_compose.stat.exists
