---
# OpenRelik database migrations

- name: Run database migrations
  block:
    - name: Wait for PostgreSQL to be ready
      command: docker exec openrelik-postgres pg_isready
      changed_when: false
      retries: 30
      delay: 5
      failed_when: false

    - name: Run migrations
      command: docker-compose exec -T openrelik-server python manage.py migrate
      args:
        chdir: "{{ openrelik_install_dir }}"
      changed_when: false
      failed_when: false
      ignore_errors: yes

  when: openrelik_run_migrations | default(true)
