version: "3.8"

x-worker-common: &worker-common
  restart: unless-stopped
  networks:
    - openrelik-network
  volumes:
    - {{ openrelik_install_dir }}/data:/data
  environment:
    - REDIS_URL=redis://openrelik-redis:6379
    - OPENRELIK_PROM_PORT=9200
  depends_on:
    - openrelik-redis

services:
  # Core services (from install script)
  openrelik-server:
    image: ghcr.io/openrelik/openrelik-server:latest
    restart: unless-stopped
    ports:
      - "{{ openrelik_api_port }}:{{ openrelik_api_port }}"
    networks:
      - openrelik-network
    volumes:
      - {{ openrelik_install_dir }}/data:/data
      - {{ openrelik_install_dir }}/config:/config
    environment:
      - REDIS_URL=redis://openrelik-redis:6379
      - DATABASE_URL=postgresql://openrelik:openrelik@openrelik-postgres:5432/openrelik
      - OPENRELIK_CLIENT_ID={{ openrelik_client_id }}
      - OPENRELIK_CLIENT_SECRET={{ openrelik_client_secret }}
    depends_on:
      - openrelik-postgres
      - openrelik-redis

  openrelik-ui:
    image: ghcr.io/openrelik/openrelik-ui:latest
    restart: unless-stopped
    ports:
      - "{{ openrelik_ui_port }}:{{ openrelik_ui_port }}"
    networks:
      - openrelik-network
    depends_on:
      - openrelik-server

  openrelik-postgres:
    image: postgres:16
    restart: unless-stopped
    networks:
      - openrelik-network
    volumes:
      - {{ openrelik_install_dir }}/postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=openrelik
      - POSTGRES_PASSWORD=openrelik
      - POSTGRES_DB=openrelik

  openrelik-redis:
    image: redis:7
    restart: unless-stopped
    networks:
      - openrelik-network

  # Workers
{% if openrelik_workers_enabled | default(true) %}
{% for worker in openrelik_workers %}
{% if worker.enabled | default(true) %}
  openrelik-worker-{{ worker.name }}:
    <<: *worker-common
    image: {{ worker.image }}
{% endif %}
{% endfor %}
{% endif %}

networks:
  openrelik-network:
    driver: bridge
