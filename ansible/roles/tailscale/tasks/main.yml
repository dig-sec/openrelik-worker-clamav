---
# Tailscale client installation and registration with Headscale

- name: Install Tailscale
  block:
    - name: Add Tailscale GPG key
      apt_key:
        url: https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg
        state: present

    - name: Add Tailscale repository
      apt_repository:
        repo: "deb https://pkgs.tailscale.com/stable/ubuntu jammy main"
        state: present
        filename: tailscale

    - name: Install tailscale package
      apt:
        name: tailscale
        state: present
        update_cache: yes

- name: Enable tailscaled service
  systemd:
    name: tailscaled
    enabled: yes
    state: started

- name: Build tailscale up command
  set_fact:
    tailscale_up_cmd: >-
      tailscale up
      --login-server={{ tailscale_login_server }}
      --hostname={{ tailscale_hostname }}
      {% if tailscale_authkey | length > 0 %}--authkey={{ tailscale_authkey }}{% endif %}
      {% if tailscale_accept_routes %}--accept-routes{% endif %}
      {% if tailscale_exit_node %}--advertise-exit-node{% endif %}
      {% if tailscale_advertise_routes | length > 0 %}--advertise-routes={{ tailscale_advertise_routes }}{% endif %}

- name: Join Tailscale network (Headscale)
  command: "{{ tailscale_up_cmd }}"
  register: tailscale_join
  changed_when: "'Success' in tailscale_join.stdout or tailscale_join.rc == 0"
  failed_when: false
  when: tailscale_authkey | length > 0

- name: Show Tailscale status
  command: tailscale status
  register: tailscale_status
  changed_when: false
  failed_when: false

- name: Display Tailscale status
  debug:
    msg: "{{ tailscale_status.stdout_lines }}"
  when: tailscale_status.stdout_lines is defined
