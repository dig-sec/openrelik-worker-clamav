---
# Elasticsearch + Kibana deployment (Docker-based)

- name: Ensure Elastic state directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ elasticsearch_state_dir }}"
    - "{{ elasticsearch_data_dir }}"
    - "{{ elasticsearch_logs_dir }}"

- name: Set ownership for Elastic data and logs
  file:
    path: "{{ item }}"
    state: directory
    owner: 1000
    group: 1000
    mode: '0750'
  loop:
    - "{{ elasticsearch_data_dir }}"
    - "{{ elasticsearch_logs_dir }}"

- name: Render Elastic docker-compose
  template:
    src: docker-compose.yml.j2
    dest: "{{ elasticsearch_state_dir }}/docker-compose.yml"
    mode: '0644'

- name: Launch Elasticsearch and Kibana
  community.docker.docker_compose_v2:
    project_src: "{{ elasticsearch_state_dir }}"
    state: present
  register: elastic_up

- name: Show Elastic stack status
  command: docker compose ps
  args:
    chdir: "{{ elasticsearch_state_dir }}"
  register: elastic_ps
  changed_when: false

- name: Display Elastic access information
  debug:
    msg:
      - "Elasticsearch: http://127.0.0.1:{{ elasticsearch_port }}"
      - "Kibana:        http://127.0.0.1:{{ kibana_port }}"
