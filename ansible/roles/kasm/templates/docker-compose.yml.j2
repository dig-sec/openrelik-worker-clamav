# Kasm Workspaces Docker Compose
# Accessed via nginx proxy on port {{ kasm_proxy_port }}

services:
{% if kasm_tor_enabled %}
  kasm-tor-browser:
    image: {{ kasm_tor_image }}
    container_name: kasm-tor-browser
    restart: unless-stopped
    shm_size: {{ kasm_shm_size }}
    environment:
      VNC_PW: "{{ kasm_tor_password_resolved }}"
    networks:
      - {{ kasm_isolated_network }}
    # Port exposed only to localhost for nginx proxy
    ports:
      - "127.0.0.1:6901:6901"
{% endif %}

{% if kasm_osint_enabled %}
  kasm-forensic-osint:
    image: {{ kasm_osint_image }}
    container_name: kasm-forensic-osint
    restart: unless-stopped
    shm_size: {{ kasm_shm_size }}
    environment:
      VNC_PW: "{{ kasm_osint_password_resolved }}"
    networks:
      - {{ kasm_clearweb_network }}
    # Port exposed only to localhost for nginx proxy
    ports:
      - "127.0.0.1:6902:6901"
{% endif %}

  # Nginx reverse proxy for KasmVNC WebSocket connections
  kasm-proxy:
    image: nginx:alpine
    container_name: kasm-proxy
    restart: unless-stopped
    volumes:
      - ./nginx-kasm.conf:/etc/nginx/conf.d/default.conf:ro
      - {{ kasm_tls_cert_path }}:/etc/nginx/tls/fullchain.pem:ro
      - {{ kasm_tls_key_path }}:/etc/nginx/tls/privkey.pem:ro
    ports:
      - "{{ kasm_proxy_port }}:443"
    networks:
{% if kasm_tor_enabled %}
      - {{ kasm_isolated_network }}
{% endif %}
{% if kasm_osint_enabled %}
      - {{ kasm_clearweb_network }}
{% endif %}
    depends_on:
{% if kasm_tor_enabled %}
      - kasm-tor-browser
{% endif %}
{% if kasm_osint_enabled %}
      - kasm-forensic-osint
{% endif %}

networks:
{% if kasm_tor_enabled %}
  {{ kasm_isolated_network }}:
    external: true
{% endif %}
{% if kasm_osint_enabled %}
  {{ kasm_clearweb_network }}:
    external: true
{% endif %}
