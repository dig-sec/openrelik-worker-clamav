---
# Configure PowerShell logging and auditing

- name: Create PowerShell log directory
  win_file:
    path: "C:\\ProgramData\\PowerShell\\logs"
    state: directory

- name: Enable PowerShell module logging
  win_regedit:
    path: "HKLM:\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging"
    name: "EnableModuleLogging"
    data: 1
    type: dword
  when: powershell_module_logging_enabled | default(true)

- name: Enable PowerShell script-block logging
  win_regedit:
    path: "HKLM:\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging"
    name: "EnableScriptBlockLogging"
    data: 1
    type: dword
  when: powershell_script_block_logging_enabled | default(true)

- name: Enable PowerShell transcription
  win_regedit:
    path: "HKLM:\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\Transcription"
    name: "EnableTranscripting"
    data: 1
    type: dword
  when: powershell_logging_enabled | default(true)

- name: Set PowerShell transcription output directory
  win_regedit:
    path: "HKLM:\\Software\\Policies\\Microsoft\\Windows\\PowerShell\\Transcription"
    name: "OutputDirectory"
    data: "C:\\ProgramData\\PowerShell\\logs"
    type: string
  when: powershell_logging_enabled | default(true)

- name: Enable Command-line Process Auditing
  win_shell: |
    # Enable process creation auditing
    auditpol /set /subcategory:"Process Creation" /success:enable /failure:enable
  changed_when: false
  failed_when: false
