---
# Configure RDP for remote access

- name: Enable RDP service
  win_service:
    name: "TermService"
    start_mode: auto
    state: started

- name: Allow RDP through Windows Firewall
  win_firewall_rule:
    name: "Remote Desktop"
    enabled: yes
    state: present
    direction: in
    action: allow
    protocol: tcp
    port: "3389"
    profile:
      - domain
      - private
      - public

- name: Set RDP to standard port 3389
  win_regedit:
    path: "HKLM:\\System\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp"
    name: "PortNumber"
    data: 3389
    type: dword

- name: Disable Network Level Authentication (for compatibility)
  win_regedit:
    path: "HKLM:\\System\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp"
    name: "SecurityLayer"
    data: 0
    type: dword

- name: Display RDP readiness
  debug:
    msg:
      - "RDP Service: Enabled"
      - "RDP Port: 3389"
      - "Add to Guacamole: hostname=10.20.0.30, port=3389, username={{ analyst_username }}"
