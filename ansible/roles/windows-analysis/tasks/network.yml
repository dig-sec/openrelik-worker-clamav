---
# Windows network configuration

- name: Set hostname
  win_hostname:
    name: "utgard-win"
  register: hostname_result

- name: Reboot after hostname change
  win_reboot:
    msg: "Hostname changed, rebooting..."
  when: hostname_result.reboot_required

- name: Get lab network adapter (10.20.0.x)
  win_shell: |
    Get-NetAdapter | Where-Object {$_.Name -like "*Ethernet 2*"} | Select-Object -ExpandProperty Name
  register: lab_adapter_name
  changed_when: false
  failed_when: false

- name: Configure static IP on lab network interface
  win_shell: |
    $adapter = "{{ lab_adapter_name.stdout | trim }}"
    if ($adapter) {
      Remove-NetIPAddress -InterfaceAlias $adapter -Confirm:$false -ErrorAction SilentlyContinue
      New-NetIPAddress -InterfaceAlias $adapter -IPAddress "{{ lab_ip }}" -PrefixLength 24 -DefaultGateway "{{ lab_gateway }}" -ErrorAction SilentlyContinue
      Set-DnsClientServerAddress -InterfaceAlias $adapter -ServerAddresses "{{ lab_gateway }}" -ErrorAction SilentlyContinue
    }
  when: 
    - lab_adapter_name.stdout is defined
    - lab_adapter_name.stdout | trim | length > 0
  register: static_ip_result
  changed_when: static_ip_result.rc == 0
  failed_when: false

- name: Configure static DNS resolvers
  win_dns_client:
    adapter_names: "*"
    ipv4_addresses:
      - "{{ lab_gateway }}"
  failed_when: false

- name: Display network configuration
  win_shell: |
    Get-NetIPConfiguration | Select-Object InterfaceAlias, IPv4Address, IPv4DefaultGateway | Format-Table -AutoSize
  register: net_config
  changed_when: false

- name: Show network status
  debug:
    msg: "{{ net_config.stdout_lines }}"
