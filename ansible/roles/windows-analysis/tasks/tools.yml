---
# Install analysis tools

- name: Create analysis tools directory
  win_file:
    path: "C:\\tools\\analysis"
    state: directory

# Wireshark portable
# Skip Wireshark download when offline
- name: Download Wireshark portable
  win_get_url:
    url: "https://1.na.dl.wireshark.org/win64/Wireshark-4.0.11-x64-portable.exe"
    dest: "C:\\tools\\analysis\\wireshark-portable.exe"
    force: no
  register: wireshark_dl
  failed_when: false
  when: not windows_offline_mode | default(false)

- name: FLOSS (Firefly Language Obfuscation Solver)
  block:
    - name: Download FLOSS
      win_get_url:
        url: "https://github.com/mandiant/flare-floss/releases/download/v2.1.0/floss-v2.1.0-Windows.zip"
        dest: "C:\\Windows\\Temp\\floss.zip"
        force: no
    
    - name: Extract FLOSS
      win_unzip:
        src: "C:\\Windows\\Temp\\floss.zip"
        dest: "C:\\tools\\analysis"
  rescue:
    - debug: msg="FLOSS download/extract failed - continuing"
  when: not windows_offline_mode | default(false)

# PE-sieve
- name: Download PE-sieve
  block:
    - name: Get PE-sieve
      win_get_url:
        url: "https://github.com/hasherezade/pe-sieve/releases/download/v0.3.4/pe-sieve64.exe"
        dest: "C:\\tools\\analysis\\pe-sieve64.exe"
        force: no
  rescue:
    - debug: msg="PE-sieve download failed - continuing"
  when: not windows_offline_mode | default(false)

# Strings (from Sysinternals)
- name: Ensure Strings is available
  win_copy:
    src: "C:\\tools\\sysinternals\\strings64.exe"
    dest: "C:\\tools\\analysis\\strings64.exe"
    remote_src: yes
  failed_when: false

# Python 3.11
- name: Check if Python 3 is installed
  win_shell: python --version 2>&1
  register: python_check
  changed_when: false
  failed_when: false

- name: Install Python 3.11
  block:
    - name: Download Python 3.11 installer
      win_get_url:
        url: "https://www.python.org/ftp/python/3.11.7/python-3.11.7-amd64.exe"
        dest: "C:\\Windows\\Temp\\python-installer.exe"
        force: no
    
    - name: Install Python (silent, add to PATH)
      win_shell: |
        & "C:\Windows\Temp\python-installer.exe" /quiet PrependPath=1 Include_test=0
      failed_when: false
    
    - name: Verify Python install
      win_shell: python --version
      changed_when: false
  when: python_check.rc != 0 and not windows_offline_mode | default(false)
  rescue:
    - debug: msg="Python installation failed - may already be installed"

# x64dbg
- name: Download and extract x64dbg
  block:
    - name: Download x64dbg
      win_get_url:
        url: "https://sourceforge.net/projects/x64dbg/files/latest/download"
        dest: "C:\\Windows\\Temp\\x64dbg.zip"
        force: no
    
    - name: Extract x64dbg
      win_unzip:
        src: "C:\\Windows\\Temp\\x64dbg.zip"
        dest: "C:\\tools\\analysis\\x64dbg"
  rescue:
    - debug: msg="x64dbg download failed - continuing"
  when: not windows_offline_mode | default(false)

# Summary
- name: List installed analysis tools
  win_shell: |
    Get-ChildItem "C:\tools\analysis" -File | Select-Object Name, Length | Format-Table -AutoSize
  register: tools_summary
  changed_when: false

- name: Show tools installed
  debug:
    msg: "{{ tools_summary.stdout_lines }}"
