---
# WireGuard VPN configuration (Mullvad exit)
# Allows lab VMs to browse internet through secure Mullvad tunnel

- name: Install WireGuard
  apt:
    name:
      - wireguard
      - wireguard-tools
      - resolvconf
    state: present
  when: enable_wireguard | default(false)

- name: Set WireGuard defaults
  set_fact:
    wg_enabled: "{{ enable_wireguard | default(false) }}"

- name: Configure WireGuard with Mullvad exit
  block:
    - name: Create WireGuard directory
      file:
        path: /etc/wireguard
        state: directory
        mode: '0700'

    # Method 1: Direct config content (wg0_conf variable)
    - name: Deploy WireGuard config from variable
      copy:
        content: "{{ wg0_conf }}"
        dest: /etc/wireguard/wg0.conf
        mode: '0600'
      when: (wg0_conf | default('') | length) > 0

    - name: Check for WireGuard endpoint config
      stat:
        path: "{{ role_path }}/files/{{ wg_endpoint_config_src }}"
      delegate_to: localhost
      run_once: true
      register: wg_endpoint_config_stat
      when: (wg0_conf | default('') | length) == 0

    - name: Fail when WireGuard config is missing
      fail:
        msg: >-
          WireGuard config {{ role_path }}/files/{{ wg_endpoint_config_src }} not found.
          Provide wg0_conf or place a real config in ansible/roles/firewall/files/private/.
      when:
        - (wg0_conf | default('') | length) == 0
        - wg_endpoint_config_stat is defined
        - not (wg_endpoint_config_stat.stat.exists | default(false))

    # Method 2: Select Mullvad endpoint from role files directory
    - name: Deploy WireGuard config from endpoint selection
      copy:
        src: "{{ wg_endpoint_config_src }}"
        dest: /etc/wireguard/wg0.conf
        mode: '0600'
      when:
        - (wg0_conf | default('') | length) == 0
        - wg_endpoint_config_stat is defined
        - wg_endpoint_config_stat.stat.exists

    - name: Ensure IPv6 is enabled for WireGuard
      sysctl:
        name: "{{ item }}"
        value: '0'
        sysctl_set: yes
        state: present
      loop:
        - net.ipv6.conf.all.disable_ipv6
        - net.ipv6.conf.default.disable_ipv6
        - net.ipv6.conf.lo.disable_ipv6

    - name: Ensure WireGuard interface is down before systemd start
      command: wg-quick down wg0
      changed_when: false
      failed_when: false

    - name: Enable WireGuard at boot
      systemd:
        name: wg-quick@wg0
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Wait for WireGuard interface to come up
      pause:
        seconds: 3

    - name: Verify WireGuard interface
      command: ip addr show wg0
      changed_when: false
      register: wg_status
      retries: 3
      delay: 2
      until: wg_status.rc == 0

    - name: Display WireGuard status
      debug:
        msg: "{{ wg_status.stdout_lines }}"

    - name: Test Mullvad connectivity
      command: ping -c 1 10.64.0.1
      changed_when: false
      failed_when: false
      retries: 3
      delay: 2

    - name: Reload nftables to apply WireGuard egress rules
      systemd:
        name: nftables
        state: restarted
      when: wg_enabled | bool

  when: wg_enabled | bool

- name: Show WireGuard details
  command: wg show
  changed_when: false
  when: wg_enabled | bool
