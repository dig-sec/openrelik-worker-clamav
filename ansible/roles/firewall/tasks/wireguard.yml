---
# WireGuard VPN configuration (Mullvad exit)
# Allows lab VMs to browse internet through secure Mullvad tunnel

- name: Install WireGuard
  apt:
    name:
      - wireguard
      - wireguard-tools
      - resolvconf
    state: present

- name: Set WireGuard defaults
  set_fact:
    wg_enabled: "{{ enable_wireguard | default(true) }}"

- name: Configure WireGuard with Mullvad exit
  block:
    - name: Create WireGuard directory
      file:
        path: /etc/wireguard
        state: directory
        mode: '0700'

    # Method 1: Direct config content (wg0_conf variable)
    - name: Deploy WireGuard config from variable
      copy:
        content: "{{ wg0_conf }}"
        dest: /etc/wireguard/wg0.conf
        mode: '0600'
      when: (wg0_conf | default('') | length) > 0

    # Method 2: Select Mullvad endpoint from role files directory
    - name: Deploy WireGuard config from endpoint selection
      copy:
        src: "{{ wg_endpoint }}.conf"
        dest: /etc/wireguard/wg0.conf
        mode: '0600'
      when: (wg0_conf | default('') | length) == 0

    - name: Ensure IPv6 is enabled for WireGuard
      sysctl:
        name: "{{ item }}"
        value: '0'
        sysctl_set: yes
        state: present
      loop:
        - net.ipv6.conf.all.disable_ipv6
        - net.ipv6.conf.default.disable_ipv6
        - net.ipv6.conf.lo.disable_ipv6

    - name: Ensure WireGuard interface is down before systemd start
      command: wg-quick down wg0
      changed_when: false
      failed_when: false

    - name: Enable WireGuard at boot
      systemd:
        name: wg-quick@wg0
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Verify WireGuard interface
      command: ip addr show wg0
      changed_when: false
      register: wg_status

    - name: Display WireGuard status
      debug:
        msg: "{{ wg_status.stdout_lines }}"

    - name: Test Mullvad connectivity
      command: ping -c 1 10.64.0.1
      changed_when: false
      failed_when: false

  when: wg_enabled | bool

- name: Show WireGuard details
  command: wg show
  changed_when: false
  when: wg_enabled | bool
